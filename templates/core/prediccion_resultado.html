{% extends 'base.html' %}
{% block title %}Resultado · AgroPredict{% endblock %}
{% block top_title %}Predicción #{{ p.id }} · {{ p.get_especie_display }}{% endblock %}

{% block content %}
<section class="grid-2">
  <div class="panel">
    <h3 class="h3">Resumen</h3>
    <div class="grid-list">
      <div class="row-card"><span class="muted">Ubicación</span><b>{{ p.comuna }}, {{ p.region }}</b></div>
      <div class="row-card"><span class="muted">Superficie</span><b>{{ p.superficie_ha|floatformat:2 }} ha</b></div>
      <div class="row-card"><span class="muted">Producción esperada</span><b>{{ p.produccion_esperada_t|floatformat:2 }} t</b></div>
      <div class="row-card"><span class="muted">t/ha</span><b>{{ prod_por_ha|floatformat:2 }}</b></div>
      <div class="row-card"><span class="muted">Riego</span><b>{{ p.get_sistema_riego_display }}</b></div>
      <div class="row-card"><span class="muted">Densidad</span><b>{{ p.densidad_arboles_ha }} ár/ha</b></div>
      <div class="row-card"><span class="muted">Edad</span><b>{{ p.edad_arbol_anios }} años</b></div>
    </div>

    <h3 class="h3" style="margin-top:16px;">Proyección semestral</h3>
    <svg class="chart" viewBox="0 0 700 200">
      <!-- ejes -->
      <line x1="40" y1="10" x2="40" y2="180" stroke="#E4E8F0" stroke-width="2"/>
      <line x1="40" y1="180" x2="680" y2="180" stroke="#E4E8F0" stroke-width="2"/>

      {% if points %}
        <polyline fill="none" stroke="var(--accent)" stroke-width="4" points="{{ points }}"/>
      {% else %}
        <text x="360" y="100" text-anchor="middle" fill="#9AA0AF" font-size="14">Sin datos</text>
      {% endif %}
    </svg>
  </div>

  <div class="panel">
    <h3 class="h3">Editar y recalcular</h3>
    <form method="post" class="form form-surface" id="edit-form" data-comunas-endpoint="/api/comunas/">
      {% csrf_token %}
      <div class="form-grid">
        <div class="form-control">
          <label>Especie</label>{{ form_edit.especie }}
        </div>
        <div class="form-control">
          <label>Región</label>{{ form_edit.region }}
        </div>
        <div class="form-control">
          <label>Comuna</label>{{ form_edit.comuna }}
        </div>
        <div class="form-control">
          <label>Superficie (ha)</label>{{ form_edit.superficie_ha }}
        </div>
        <div class="form-control">
          <label>Edad (años)</label>{{ form_edit.edad_arbol_anios }}
        </div>
        <div class="form-control">
          <label>Densidad (ár/ha)</label>{{ form_edit.densidad_arboles_ha }}
        </div>
        <div class="form-control">
          <label>Sistema riego</label>{{ form_edit.sistema_riego }}
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="submit">Guardar y recalcular</button>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const formEl = document.getElementById('edit-form');
  if(!formEl) return;
  const regionEl = document.getElementById('id_region');
  const comunaEl = document.getElementById('id_comuna');
  const endpointBase = formEl.dataset.comunasEndpoint || "/api/comunas/";

  const slugify = (s) => {
    return s
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[’']/g, '')
      .toLowerCase()
      .split(/\s+/).join('-');
  };

  async function loadComunas(regionName, currentComuna){
    if(!regionName) return;
    const url = endpointBase + slugify(regionName) + "/";
    try{
      const resp = await fetch(url, {credentials: "same-origin"});
      if(!resp.ok) return;
      const data = await resp.json();
      const comunas = data.comunas || [];
      const prev = currentComuna || comunaEl.value;
      comunaEl.innerHTML = "";
      const opt0 = document.createElement('option');
      opt0.value = ""; opt0.textContent = "— Selecciona comuna —";
      comunaEl.appendChild(opt0);
      comunas.forEach(c=>{
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        if(c === prev) o.selected = true;
        comunaEl.appendChild(o);
      });
    }catch(e){}
  }

  regionEl && regionEl.addEventListener('change', (e)=>{
    loadComunas(e.target.value);
  });

  // Primer render
  if(regionEl && regionEl.value){
    loadComunas(regionEl.value, comunaEl.value);
  }
})();
</script>
{% endblock %}
