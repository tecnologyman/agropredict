{% extends 'base.html' %}
{% load static %}
{% block title %}Nueva Predicción · AgroPredict{% endblock %}
{% block top_title %}Crear predicción{% endblock %}

{% block content %}
<form method="post" class="card form form-surface" id="pred-form" data-comunas-endpoint="/api/comunas/">
  {% csrf_token %}

  <div class="form-grid">
    <!-- Columna izquierda -->
    <div class="field-panel">
      <div class="panel-head">Especie</div>
      <div class="form-control">{{ form.especie.label_tag }}{{ form.especie }}</div>

      <div class="panel-head">Ubicación</div>
      <div class="form-control">
        <label>Región</label>
        {{ form.region }}
      </div>
      <div class="form-control">
        <label>Comuna</label>
        {{ form.comuna }}
      </div>

      <div class="panel-foot small-muted">Selecciona región para cargar comunas.</div>
    </div>

    <!-- Columna derecha -->
    <div class="field-panel">
      <div class="panel-head">Parámetros del huerto</div>
      <div class="form-control">
        <label>Superficie Plantada (ha)</label>
        {{ form.superficie_ha }}
      </div>
      <div class="form-control">
        <label>Edad del árbol (años)</label>
        {{ form.edad_arbol_anios }}
      </div>
      <div class="form-control">
        <label>Densidad de plantación (árboles/ha)</label>
        {{ form.densidad_arboles_ha }}
      </div>
      <div class="form-control">
        <label>Sistema de riego</label>
        {{ form.sistema_riego }}
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" type="submit">Calcular predicción</button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const formEl = document.getElementById('pred-form');
  const regionEl = document.getElementById('id_region');
  const comunaEl = document.getElementById('id_comuna');
  const endpointBase = formEl.dataset.comunasEndpoint || "/api/comunas/";

  // slugify compatible con el servidor
  const slugify = (s) => {
    return s
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[’']/g, '')
      .toLowerCase()
      .split(/\s+/).join('-');
  };

  async function loadComunas(regionName){
    if(!regionName) return;
    const url = endpointBase + slugify(regionName) + "/";
    try{
      const resp = await fetch(url, {credentials: "same-origin"});
      if(!resp.ok) return;
      const data = await resp.json();
      const comunas = data.comunas || [];
      comunaEl.innerHTML = "";
      const opt0 = document.createElement('option');
      opt0.value = ""; opt0.textContent = "— Selecciona comuna —";
      comunaEl.appendChild(opt0);
      comunas.forEach(c=>{
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        comunaEl.appendChild(o);
      });
    }catch(e){}
  }

  regionEl && regionEl.addEventListener('change', (e)=>{
    loadComunas(e.target.value);
  });

  // Primer render (si viene con región en instancia/POST)
  if(regionEl && regionEl.value){
    loadComunas(regionEl.value);
  }
})();
</script>
{% endblock %}
