{% extends 'base.html' %}
{% block title %}Crear predicción · AgroPredict{% endblock %}
{% block top_title %}Crear predicción{% endblock %}

{% block content %}
<section class="card form-card gradient-card">
  <form method="post" class="form">
    {% csrf_token %}

    <!-- Mensajes de error globales -->
    {{ form.non_field_errors }}

    <!-- GRID 2 columnas -->
    <div class="form-grid two-col">
  <!-- Columna izquierda -->
  <div class="form-col">
    <div class="form-control colorized fc-morado">
      <label>Especie</label>
      {{ form.especie }} {{ form.especie.errors }}
    </div>

    <div class="form-control colorized fc-azul">
      <label>Comuna</label>
      {{ form.comuna }} {{ form.comuna.errors }}
    </div>

    <div class="form-control colorized fc-magenta">
      <label>Edad del árbol (años)</label>
      {{ form.edad_arbol_anios }} {{ form.edad_arbol_anios.errors }}
    </div>

    <div class="form-control colorized fc-verde">
      <label>Sistema de riego</label>
      {{ form.sistema_riego }} {{ form.sistema_riego.errors }}
    </div>
  </div>

  <!-- Columna derecha -->
  <div class="form-col">
    <div class="form-control colorized fc-morado">
      <label>Región</label>
      {{ form.region }} {{ form.region.errors }}
    </div>

    <div class="form-control colorized fc-magenta">
      <label>Superficie Plantada (ha)</label>
      {{ form.superficie_ha }} {{ form.superficie_ha.errors }}
    </div>

    <div class="form-control colorized fc-azul">
      <label>Densidad de plantación (árboles/ha)</label>
      {{ form.densidad_arboles_ha }} {{ form.densidad_arboles_ha.errors }}
    </div>
  </div>
</div>

    <div class="actions">
      <button class="btn" type="submit">Calcular predicción</button>
      <a href="/" class="btn-link">Cancelar</a>
    </div>
  </form>
</section>

<!-- ==== JS: Region -> Comunas (select dependiente) ==== -->
<script>
(function(){
  const regionSelect = document.getElementById("id_region");
  const comunaSelect = document.getElementById("id_comuna");

  if (!regionSelect || !comunaSelect) return;

  // Normaliza a slug (como en cl_geo.region_slug)
  function toSlug(txt){
    return (txt || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[’']/g,"")
      .replace(/\s+/g,"-")
      .replace(/[^a-z0-9-]/g,"");
  }

  async function cargarComunas(regionName, preselect){
    const slug = toSlug(regionName);
    try{
      const resp = await fetch(`/api/comunas/${slug}/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!resp.ok) throw new Error("HTTP " + resp.status);
      const data = await resp.json();
      const comunas = data.comunas || [];

      // Limpia y arma opciones
      comunaSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = ""; ph.textContent = "— Selecciona comuna —";
      comunaSelect.appendChild(ph);

      comunas.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        if(preselect && preselect === c) opt.selected = true;
        comunaSelect.appendChild(opt);
      });

      // Forzar estilo/validación si tu widget lo requiere
      comunaSelect.dispatchEvent(new Event('change'));
    }catch(e){
      console.error("No se pudieron cargar comunas:", e);
    }
  }

  // Cuando cambia la región
  regionSelect.addEventListener("change", (ev)=>{
    cargarComunas(regionSelect.value, null);
  });

  // Primera carga: si ya hay región (y quizá comuna) desde instancia
  const preselectedComuna = "{{ form.initial.comuna|default_if_none:'' }}";
  if (regionSelect.value) {
    cargarComunas(regionSelect.value, preselectedComuna);
  }
})();
</script>
{% endblock %}
